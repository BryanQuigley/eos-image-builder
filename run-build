#!/bin/bash -ex
# -*- mode: Shell-script; sh-basic-offset: 2; indent-tabs-mode: nil -*-
export EOB_SRC=$(dirname $(readlink -f $0))
export EOB_SYSCONF=/etc/eos-image-builder
export EOB_BASELIB="${EOB_SRC}"/lib/eob.sh
export PATH=$EOB_SRC/stages:$PATH
export PYTHONPATH=$EOB_SRC/lib

export LANG=C
unset LANGUAGE LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
unset LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT LC_IDENTIFICATION
unset LC_ALL
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true
export DEBIAN_PRIORITY=critical

# Make sure ERR traps follow through to shell functions
set -E

usage() {
  cat <<EOF
Usage: eos-image-builder [OPTION]... [BRANCH]
Build and publish images for Endless

  -p, --product         product to build
  --platform            platform to build
  -P, --personalities   personalities to build
  -n, --dry-run         don't publish images
  --no-checkout         use current builder branch
  -h, --help            display this help and exit

If BRANCH is not specified, master is used.
EOF
}

args=$(getopt -o "p:P:nh" \
  -l "product:,platform:,personalities:,dry-run,no-checkout,help" \
  -n "eos-image-builder" -- "$@")
eval set -- "${args}"

while true; do
  case "$1" in
    -p|--product)
      EOB_PRODUCT=$2
      shift 2
      ;;
    --platform)
      EOB_PLATFORM=$2
      shift 2
      ;;
    -P|--personalities)
      EOB_PERSONALITIES=$2
      shift 2
      ;;
    -n|--dry-run)
      export EOB_DRY_RUN=true
      shift
      ;;
    --no-checkout)
      # Ignored, only used in top level script
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
  esac
done

# Some configuration defaults
# Debian package repository from where OS packages will be obtained
export EOB_OBS_REPO=http://obs-master.endlessm-sf.com:82/shared/eos

export EOB_BRANCH=${1:-master}
export EOB_PRODUCT=${EOB_PRODUCT:-eos}

# GPG private key ID to sign ostree commit. The key with this ID must be
# available in ${EOB_SYSCONF}/gnupg
# EOSK1 key expiring 2019-05-13.
EOB_OSTREE_KEYID=BA02FC46
export EOB_OSTREE_KEYID

export EOB_IMAGE_SIGNING_KEYID=587A279C

case "$(uname -m)" in
  x86_64|i?86)
    export EOB_ARCH=i386
    export EOB_PLATFORM=${EOB_PLATFORM:-i386}
    ;;

  arm*)
    export EOB_ARCH=armhf
    export EOB_PLATFORM=${EOB_PLATFORM:-odroidu2}
    ;;
esac

# By default, only the base personality image is built.
export EOB_PERSONALITIES=${EOB_PERSONALITIES:-base}

# Create 2 disk split images for everything except eosdev.
case "${EOB_PRODUCT}" in
  eosdev)
    EOB_SPLIT_IMAGES=false
    ;;
  *)
    EOB_SPLIT_IMAGES=true
    ;;
esac
export EOB_SPLIT_IMAGES

export EOB_BUILD_VERSION=$(date +%y%m%d-%H%M%S)
export EOB_OSTREE_BRANCH=${EOB_BRANCH}/${EOB_PLATFORM}
export EOB_OSTREE_REPO=${EOB_PRODUCT}-${EOB_ARCH}
export EOB_OSTREE_OS=${EOB_PRODUCT}

# The eos and eosnonfree products are handled a bit counterintuitively.
# For both products, we want to continue using the eos OS name. For eos,
# we will temporarily use a separate repo called eosfree-$arch. For
# eosnonfree, it will continue using the eos-$arch repo so our users
# with codecs continue to get updates. Later, when the OS is clean
# again, the eosfree-$arch repo will go away and both will use the
# eos-$arch repo.
case "${EOB_PRODUCT}" in
  eos)
    EOB_OSTREE_REPO=eosfree-${EOB_ARCH}
    ;;
  eosnonfree)
    EOB_OSTREE_REPO=eos-${EOB_ARCH}
    EOB_OSTREE_OS=eos
    ;;
esac

# Multiple stable minor version branches may be in use, but the deployed
# ostree configuration should use only the major version. E.g., the real
# branch may be eos2.2, but the deployed configuration should use eos2.
export EOB_OSTREE_BRANCH_DEPLOY=${EOB_BRANCH%.*}/${EOB_PLATFORM}

# The ostree URL that the final system will query for updates. Not used
# during build time. The product (e.g. eos) and arch is taken as a
# subdirectory of this address.
export EOB_OSTREE_URL_ROOT="https://endless:***REMOVED***@ostree.endlessm.com"
if [[ "${EOB_BRANCH}" == "master" ]]; then
  export EOB_OSTREE_URL_BASE="${EOB_OSTREE_URL_ROOT}/staging/dev"
else
  export EOB_OSTREE_URL_BASE="${EOB_OSTREE_URL_ROOT}/ostree"
fi
export EOB_OSTREE_URL=${EOB_OSTREE_URL_BASE}/${EOB_OSTREE_REPO}

# Internal ostree server URL. This is used to pull the most recent
# commit and to push the new commit.
export EOB_OSTREE_INT_HOST=ostree.endlessm-sf.com
export EOB_OSTREE_INT_USER=uploader
export EOB_OSTREE_INT_DIR="/srv/ostree/www/${EOB_OSTREE_REPO}"
export EOB_OSTREE_INT_URL="http://${EOB_OSTREE_INT_HOST}/${EOB_OSTREE_REPO}"

# Support adding a ref on an alternate branch. By default, no alternate
# is used.
export EOB_OSTREE_BRANCH_ALT=

# Image uploading
export EOB_IMAGE_HOST_SHORT=obs-repository
export EOB_IMAGE_HOST=${EOB_IMAGE_HOST_SHORT}.endlessm-sf.com
export EOB_IMAGE_USER=uploader
export EOB_IMAGE_PATH=/srv/images/www
export EOB_IMAGE_DEST=${EOB_IMAGE_PATH}/${EOB_PRODUCT}-${EOB_ARCH}-${EOB_PLATFORM}/${EOB_BRANCH}/${EOB_BUILD_VERSION}

# Image URLs
EOB_IMAGE_URL_ROOT="http://images.endlessm-sf.com/"
EOB_IMAGE_URL_BASE="${EOB_IMAGE_URL_ROOT}/${EOB_PRODUCT}-${EOB_ARCH}-${EOB_PLATFORM}/${EOB_BRANCH}/${EOB_BUILD_VERSION}"
export EOB_IMAGE_URL_ROOT EOB_IMAGE_URL_BASE

# Email settings
EOB_EMAIL_FROM=image-builder@endlessm.com
EOB_EMAIL_REPLYTO=endless-dev@endlessm.com
EOB_EMAIL_TO=endless-dev-status@endlessm.com
export EOB_EMAIL_FROM EOB_EMAIL_REPLYTO EOB_EMAIL_TO

# Jenkins triggering
EOB_JENKINS_URL="http://ci.endlessm-sf.com:8080"
EOB_JENKINS_USER=image-builder
EOB_JENKINS_TOKEN="${EOB_SYSCONF}"/jenkins-token
export EOB_JENKINS_URL EOB_JENKINS_USER EOB_JENKINS_TOKEN

# Read system config overrides
[[ -e "${EOB_SYSCONF}"/config ]] && . "${EOB_SYSCONF}"/config

# Read user config overrides
[[ -e "${EOB_SRC}"/config ]] && . "${EOB_SRC}"/config

. "${EOB_BASELIB}"

recreate_dir "${EOB_OUTDIR}"
recreate_dir "${EOB_TMPDIR}"
exec > >(tee $(eob_outfile build.txt))
exec 2>&1

mkdir -p "${EOB_CONTENT}"
. "${EOB_SRC}"/buildscript

# Unless this is a dry run, the output files have been published and can
# be deleted.
[ -n "${EOB_DRY_RUN}" ] || rm -rf "${EOB_OUTDIR}"
