# Put KA Lite's content in the right place and write default config

kalitehome=${OSTREE_VAR}/lib/kalite
preloaded=${kalitehome}/PRELOADED

# Skip if the kalite helper is not installed
if ! test -f ${OSTREE_DEPLOYMENT}/lib/systemd/system/eos-kalite-system-helper.socket; then
    exit 0
fi

rm -rf ${kalitehome}/*
mkdir -p ${preloaded}
cp -r ${EIB_CONTENTDIR}/kalite/* ${preloaded}

# set content permissions
chown -R $(ostree_uid kalite):$(ostree_gid kalite) ${preloaded}
find ${preloaded} -type f -exec chmod 664 '{}' ';'
chmod 775 ${preloaded}

# EIB_IMAGE_LANGUAGE could not be defined
if [ -z "${EIB_IMAGE_LANGUAGE}" ]; then
    exit 0
fi
current_lang=$(locale_to_iso_639_1 ${EIB_IMAGE_LANGUAGE})
echo "LANG: ${current_lang}"

# No need to set LANGUAGE_CODE for the default 'C' locale
if [ "${current_lang}" = "C" ]; then
    exit 0
fi

cat <<EOF > ${kalitehome}/settings.py
# This is the default location where the kalite command finds its settings
# You can change the below lines to use different default settings or
# you can run kalite <command> --settings=other_module

from kalite.project.settings.base import *

# from kalite.project.settings.dev import *
# from kalite.project.settings.raspberry_pi import *

LANGUAGE_CODE="${lang}"
EOF
