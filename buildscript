#!/bin/bash -ex
# -*- mode: Shell-script; sh-basic-offset: 2; indent-tabs-mode: nil -*-
# Run the eib_error stage on errors. Return code 2 is used for image
# build failures to differentiate from locking failures.
stage_error() {
  eib_error
  exit 2
}
trap stage_error ERR

# Ensure all needed settings are available from the environment.
for var in EIB_BASELIB EIB_SRCDIR EIB_BUILDDIR EIB_OSTREE_CHECKOUT \
  EIB_OSTREE_REPODIR EIB_DATADIR EIB_HELPERSDIR EIB_OUTROOTDIR \
  EIB_CACHEDIR EIB_TMPDIR EIB_OSTREE_TMPDIR EIB_CONTENTDIR \
  EIB_APPS_CONTENTDIR
do
  if [ ! -v $var ]; then
    echo "error: required variable $var not set" >&2
    exit 1
  fi
done

# Read system config overrides
[[ -e "${EIB_SYSCONFDIR}"/config ]] && . "${EIB_SYSCONFDIR}"/config

# Read user config overrides
[[ -e "${EIB_SRCDIR}"/config ]] && . "${EIB_SRCDIR}"/config

. "${EIB_BASELIB}"

exec > >(tee "${EIB_TMPDIR}"/build.txt)
exec 2>&1

# Check if build needed and exit early if not
if eib_check_update && [ -z "${EIB_FORCE}" ]; then
  exit 0
fi

# Real build stages
eib_ostree
eib_image
eib_publish
